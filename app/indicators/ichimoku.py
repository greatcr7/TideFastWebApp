from datetime import datetime, timedelta
import streamlit as st
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import pandas as pd
import yfinance as yf  # Using yfinance for data retrieval
from ta.trend import IchimokuIndicator, EMAIndicator
import pytz

from data.stock import get_stock_prices

# ---------------------------
# Ichimoku Cloud Analysis Function
# ---------------------------

def ichimoku_analysis(ticker):
    st.markdown(f"# üìà ‰∏ÄÁõÆÂùáË°°Âõæ for {ticker.upper()}")

    # Sidebar for user inputs specific to Ichimoku Analysis
    st.sidebar.header("ÊåáÊ†áÂèÇÊï∞")

    # Function to convert period to start and end dates
    def convert_period_to_dates(period):
        # Define Beijing timezone
        beijing_tz = pytz.timezone('Asia/Shanghai')  # Beijing shares the same timezone as Shanghai

        # Get current time in Beijing
        end_date = datetime.now(beijing_tz)

        # Calculate start date based on the selected period
        if period == "1mo":
            start_date = end_date - timedelta(days=30)
        elif period == "3mo":
            start_date = end_date - timedelta(days=90)
        elif period == "6mo":
            start_date = end_date - timedelta(days=180)
        elif period == "1y":
            start_date = end_date - timedelta(days=365)
        elif period == "2y":
            start_date = end_date - timedelta(days=365*2)
        elif period == "5y":
            start_date = end_date - timedelta(days=365*5)
        elif period == "10y":
            start_date = end_date - timedelta(days=365*10)
        else:
            start_date = end_date

        # Convert to 'YYYY-MM-DD' format
        return start_date.strftime("%Y-%m-%d"), end_date.strftime("%Y-%m-%d")

    # User input function
    def user_input_features():
        period = st.sidebar.selectbox(
            "Êó∂Èó¥Ë∑®Â∫¶ (Time Period)", 
            options=["1mo", "3mo", "6mo", "1y", "2y", "5y", "10y"], 
            index=3
        )
        return convert_period_to_dates(period)

    # Getting user input
    start_date, end_date = user_input_features()

    # Step 1: Fetch Historical Data using get_stock_prices function
    df = get_stock_prices(ticker, start_date, end_date)

    if df is None or df.empty:
        st.error("Êú™Ëé∑ÂèñÂà∞Êï∞ÊçÆ„ÄÇËØ∑Ê£ÄÊü•ËÇ°Á•®‰ª£Á†ÅÂπ∂ÈáçËØï„ÄÇ (No data fetched. Please check the ticker symbol and try again.)")
        st.stop()

    # Step 2: User Inputs for Ichimoku Parameters
    st.sidebar.header("‰∏ÄÁõÆÂùáË°°ÂõæÂèÇÊï∞")

    # Default Ichimoku periods
    default_conversion_line_period = 9
    default_base_line_period = 26
    default_span_b_period = 52
    default_displacement = 26

    conversion_line_period = st.sidebar.number_input(
        "ËΩ¨Êç¢Á∫øÂë®Êúü (Conversion Line Period)", 
        min_value=1, 
        max_value=100, 
        value=default_conversion_line_period, 
        step=1,
        help="Áî®‰∫éËÆ°ÁÆóËΩ¨Êç¢Á∫øÁöÑÂë®Êúü„ÄÇÊé®ËçêÂÄºÔºö9„ÄÇ (Period for calculating the Conversion Line. Recommended value: 9.)"
    )

    base_line_period = st.sidebar.number_input(
        "Âü∫ÂáÜÁ∫øÂë®Êúü (Base Line Period)", 
        min_value=1, 
        max_value=200, 
        value=default_base_line_period, 
        step=1,
        help="Áî®‰∫éËÆ°ÁÆóÂü∫ÂáÜÁ∫øÁöÑÂë®Êúü„ÄÇÊé®ËçêÂÄºÔºö26„ÄÇ (Period for calculating the Base Line. Recommended value: 26.)"
    )

    span_b_period = st.sidebar.number_input(
        "È¢ÜÂÖàË∑®Â∫¶BÂë®Êúü (Leading Span B Period)", 
        min_value=1, 
        max_value=300, 
        value=default_span_b_period, 
        step=1,
        help="Áî®‰∫éËÆ°ÁÆóÈ¢ÜÂÖàË∑®Â∫¶BÁöÑÂë®Êúü„ÄÇÊé®ËçêÂÄºÔºö52„ÄÇ (Period for calculating Leading Span B. Recommended value: 52.)"
    )

    displacement = st.sidebar.number_input(
        "‰ΩçÁßª (Displacement)", 
        min_value=1, 
        max_value=100, 
        value=default_displacement, 
        step=1,
        help="È¢ÜÂÖàË∑®Â∫¶ÁöÑ‰ΩçÁßª„ÄÇÊé®ËçêÂÄºÔºö26„ÄÇ (Displacement for leading spans. Recommended value: 26.)"
    )

    # Additional Parameters
    st.sidebar.header("ÂÖ∂‰ªñÂèÇÊï∞")

    ema_short_window = st.sidebar.number_input(
        "EMA Áü≠ÊúüÁ™óÂè£ (EMA Short Window)", 
        min_value=10, 
        max_value=100, 
        value=50,  # Common default
        step=5,
        help="Áü≠ÊúüÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫øÔºàEMAÔºâÁöÑÁ™óÂè£Â§ßÂ∞è„ÄÇËæÉÁü≠ÁöÑÁ™óÂè£‰Ωø EMA Êõ¥ÊïèÊÑü„ÄÇÊé®ËçêÂÄºÔºö50„ÄÇ (Short-term EMA window size. A shorter window makes the EMA more sensitive. Recommended value: 50.)"
    )

    ema_long_window = st.sidebar.number_input(
        "EMA ÈïøÊúüÁ™óÂè£ (EMA Long Window)", 
        min_value=100, 
        max_value=300, 
        value=200,  # Common default
        step=10,
        help="ÈïøÊúüÊåáÊï∞ÁßªÂä®Âπ≥ÂùáÁ∫øÔºàEMAÔºâÁöÑÁ™óÂè£Â§ßÂ∞è„ÄÇËæÉÈïøÁöÑÁ™óÂè£‰Ωø EMA Êõ¥Âπ≥Êªë„ÄÇÊé®ËçêÂÄºÔºö200„ÄÇ (Long-term EMA window size. A longer window makes the EMA smoother. Recommended value: 200.)"
    )

    crossover_window = st.sidebar.number_input(
        "‰∫§ÂèâÊ£ÄÊµãÁ™óÂè£ (Crossover Window)", 
        min_value=1, 
        max_value=10, 
        value=1,  # Common default
        step=1,
        help="ÂÆö‰πâÊ£ÄÊµã‰∫§ÂèâÁöÑÊúÄÂ∞èÂ§©Êï∞Ôºå‰ª•ÈÅøÂÖçËôöÂÅá‰ø°Âè∑„ÄÇÊé®ËçêÂÄºÔºö1„ÄÇ (Defines the minimum number of days to detect crossovers to avoid false signals. Recommended value: 1.)"
    )

    # Plotting Options
    st.sidebar.header("ÁªòÂõæÈÄâÈ°π")
    show_ema = st.sidebar.checkbox("ÊòæÁ§∫ EMA (Show EMAs)", value=True)
    show_ichimoku = st.sidebar.checkbox("ÊòæÁ§∫ Ichimoku Cloud (Show Ichimoku Cloud)", value=True)

    # Calculate Ichimoku using ta
    ichimoku_indicator = IchimokuIndicator(
        high=df['high'], 
        low=df['low'], 
        window1=conversion_line_period, 
        window2=base_line_period, 
        window3=span_b_period
    )
    df['Ichimoku_Conversion'] = ichimoku_indicator.ichimoku_conversion_line()
    df['Ichimoku_Base'] = ichimoku_indicator.ichimoku_base_line()
    df['Ichimoku_A'] = ichimoku_indicator.ichimoku_a()
    df['Ichimoku_B'] = ichimoku_indicator.ichimoku_b()
    df['Ichimoku_Cloud_Upper'] = df[['Ichimoku_A', 'Ichimoku_B']].max(axis=1)
    df['Ichimoku_Cloud_Lower'] = df[['Ichimoku_A', 'Ichimoku_B']].min(axis=1)

    # Calculate EMAs using ta
    ema_short_indicator = EMAIndicator(close=df['close'], window=ema_short_window)
    ema_long_indicator = EMAIndicator(close=df['close'], window=ema_long_window)
    df['EMA_Short'] = ema_short_indicator.ema_indicator()
    df['EMA_Long'] = ema_long_indicator.ema_indicator()

    # Identify Crossovers between EMAs
    def identify_crossovers(df, short_col='EMA_Short', long_col='EMA_Long', window=1):
        bullish_crossovers = []
        bearish_crossovers = []

        for i in range(window, len(df)):
            if (df[short_col].iloc[i] > df[long_col].iloc[i]) and (df[short_col].iloc[i - window] <= df[long_col].iloc[i - window]):
                bullish_crossovers.append({
                    'Date': df['date'].iloc[i],
                    'Price': df['close'].iloc[i],
                    short_col: df[short_col].iloc[i],
                    long_col: df[long_col].iloc[i]
                })
            elif (df[short_col].iloc[i] < df[long_col].iloc[i]) and (df[short_col].iloc[i - window] >= df[long_col].iloc[i - window]):
                bearish_crossovers.append({
                    'Date': df['date'].iloc[i],
                    'Price': df['close'].iloc[i],
                    short_col: df[short_col].iloc[i],
                    long_col: df[long_col].iloc[i]
                })

        return bullish_crossovers, bearish_crossovers

    bullish_crossovers, bearish_crossovers = identify_crossovers(df, window=crossover_window)

    # Identify Confluences
    def find_confluence(df, ema_short, ema_long, ichimoku_a, ichimoku_b, price_col='close'):
        latest_ema_short = df['EMA_Short'].iloc[-1]
        latest_ema_long = df['EMA_Long'].iloc[-1]
        latest_ichimoku_a = df['Ichimoku_A'].iloc[-1]
        latest_ichimoku_b = df['Ichimoku_B'].iloc[-1]
        latest_price = df[price_col].iloc[-1]

        confluence_levels = {}

        # Bullish Confluence
        if (latest_ema_short > latest_ema_long) and (latest_price > latest_ema_short) and (latest_ichimoku_a > latest_ichimoku_b):
            confluence_levels['Bullish Confluence'] = {
                'EMA_Short': latest_ema_short,
                'EMA_Long': latest_ema_long,
                'Ichimoku_A': latest_ichimoku_a,
                'Ichimoku_B': latest_ichimoku_b,
                'Price': latest_price
            }
        # Bearish Confluence
        elif (latest_ema_short < latest_ema_long) and (latest_price < latest_ema_short) and (latest_ichimoku_a < latest_ichimoku_b):
            confluence_levels['Bearish Confluence'] = {
                'EMA_Short': latest_ema_short,
                'EMA_Long': latest_ema_long,
                'Ichimoku_A': latest_ichimoku_a,
                'Ichimoku_B': latest_ichimoku_b,
                'Price': latest_price
            }

        return confluence_levels, df

    confluences, df = find_confluence(df, ema_short_window, ema_long_window, 'Ichimoku_A', 'Ichimoku_B')


    # Determine Trend
    def determine_trend(df, confluences):
        latest_price = df['close'].iloc[-1]
        latest_ema_short = df['EMA_Short'].iloc[-1]
        latest_ema_long = df['EMA_Long'].iloc[-1]
        latest_ichimoku_a = df['Ichimoku_A'].iloc[-1]
        latest_ichimoku_b = df['Ichimoku_B'].iloc[-1]

        if (latest_price > latest_ema_short) and (latest_price > latest_ema_long) and (latest_ichimoku_a > latest_ichimoku_b):
            trend = "‰∏äÂçáË∂ãÂäø (Uptrend)"
        elif (latest_price < latest_ema_short) and (latest_price < latest_ema_long) and (latest_ichimoku_a < latest_ichimoku_b):
            trend = "‰∏ãÈôçË∂ãÂäø (Downtrend)"
        else:
            trend = "ÈúáËç°Âå∫Èó¥ (Sideways)"

        return trend, latest_price

    trend, current_price = determine_trend(df, confluences)

    # Step 3: Plot Using Plotly
    def plot_ichimoku(df, bullish_crossovers, bearish_crossovers, confluences, ticker, 
                     show_ema=True, show_ichimoku=True):
        """
        Plot the Ichimoku Cloud along with price data and EMAs using Plotly.
        """
        fig = make_subplots(
            rows=1, cols=1, shared_xaxes=True,
            vertical_spacing=0.05, 
            subplot_titles=(f'{ticker} ÁöÑËÇ°‰ª∑Âíå Ichimoku Cloud (Price and Ichimoku Cloud)'),
            row_width=[0.2]
        )

        # Candlestick for Price
        fig.add_trace(
            go.Candlestick(
                x=df['date'],
                open=df['open'],
                high=df['high'],
                low=df['low'],
                close=df['close'],
                name='‰ª∑Ê†º (Price)'
            ), 
            row=1, col=1
        )

        # EMAs
        if show_ema:
            fig.add_trace(
                go.Scatter(
                    x=df['date'], 
                    y=df['EMA_Short'], 
                    line=dict(color='blue', width=1), 
                    name=f'EMA{ema_short_window}'
                ), 
                row=1, col=1
            )
            fig.add_trace(
                go.Scatter(
                    x=df['date'], 
                    y=df['EMA_Long'], 
                    line=dict(color='purple', width=1), 
                    name=f'EMA{ema_long_window}'
                ), 
                row=1, col=1
            )

        # Ichimoku Cloud
        if show_ichimoku:
            # Senkou Span A and B to form the cloud
            fig.add_trace(
                go.Scatter(
                    x=df['date'], 
                    y=df['Ichimoku_A'], 
                    line=dict(color='green', width=1, dash='dot'), 
                    name='Ichimoku A'
                ), 
                row=1, col=1
            )
            fig.add_trace(
                go.Scatter(
                    x=df['date'], 
                    y=df['Ichimoku_B'], 
                    line=dict(color='red', width=1, dash='dot'), 
                    name='Ichimoku B'
                ), 
                row=1, col=1
            )
            # Fill the cloud
            fig.add_traces([
                go.Scatter(
                    x=pd.concat([df['date'], df['date'][::-1]]),
                    y=pd.concat([df['Ichimoku_A'], df['Ichimoku_B'][::-1]]),
                    fill='toself',
                    fillcolor='rgba(0, 255, 0, 0.1)' if df['Ichimoku_A'].iloc[-1] > df['Ichimoku_B'].iloc[-1] else 'rgba(255, 0, 0, 0.1)',
                    line=dict(color='rgba(255,255,255,0)'),
                    hoverinfo="skip",
                    showlegend=False
                )
            ])

        # Crossovers Markers on Price Chart
        crossover_dates_bull = [div['Date'] for div in bullish_crossovers]
        crossover_prices_bull = [div['Price'] for div in bullish_crossovers]
        crossover_dates_sell = [div['Date'] for div in bearish_crossovers]
        crossover_prices_sell = [div['Price'] for div in bearish_crossovers]

        if crossover_dates_bull and crossover_prices_bull:
            fig.add_trace(
                go.Scatter(
                    mode='markers', 
                    x=crossover_dates_bull, 
                    y=crossover_prices_bull,
                    marker=dict(color='green', size=10, symbol='triangle-up'),
                    name='ÁúãÊ∂®‰∫§Âèâ (Bullish Crossover)'
                ), 
                row=1, col=1
            )
        if crossover_dates_sell and crossover_prices_sell:
            fig.add_trace(
                go.Scatter(
                    mode='markers', 
                    x=crossover_dates_sell, 
                    y=crossover_prices_sell,
                    marker=dict(color='red', size=10, symbol='triangle-down'),
                    name='ÁúãË∑å‰∫§Âèâ (Bearish Crossover)'
                ), 
                row=1, col=1
            )

        # Highlight Confluence Zones
        for key, value in confluences.items():
            if key == 'Bullish Confluence':
                color = 'green'
                annotation_text = 'ÁúãÊ∂®ÂÖ±ÊåØÂå∫ (Bullish Confluence)'
            elif key == 'Bearish Confluence':
                color = 'red'
                annotation_text = 'ÁúãË∑åÂÖ±ÊåØÂå∫ (Bearish Confluence)'
            else:
                color = 'yellow'
                annotation_text = 'ÂÖ±ÊåØÂå∫ (Confluence)'

            fig.add_hline(
                y=value['Price'], 
                line=dict(color=color, dash='dash'), 
                row=1, col=1,
                annotation_text=annotation_text,
                annotation_position="top left"
            )

        fig.update_layout(
            title=f"{ticker} ÁöÑ Ichimoku Cloud ÂàÜÊûê",
            yaxis_title='‰ª∑Ê†º (Price)',
            xaxis_title='Êó•Êúü (Date)',
            template='plotly_dark',
            showlegend=True,
            height=800
        )

        fig.update_xaxes(rangeslider_visible=False)

        return fig

    fig = plot_ichimoku(df, bullish_crossovers, bearish_crossovers, confluences, ticker, 
                       show_ema=show_ema, show_ichimoku=show_ichimoku)
    st.plotly_chart(fig, use_container_width=True)

     # Step 4: Detailed Actionable Interpretation in Both English and Chinese
    def detailed_interpretation(bullish_crossovers, bearish_crossovers, confluences, current_price, trend, 
                                conversion_line_period, base_line_period, span_b_period, displacement,
                                ema_short_window, ema_long_window):
        """
        Provide a detailed, actionable interpretation based on Ichimoku and crossovers in both English and Chinese.
        """
        interpretation_en = ""
        interpretation_cn = ""

        # 1. Trend Analysis
        interpretation_en += f"###### Current Market Trend: {trend}\n\n"
        interpretation_en += f"**Current Price**: {current_price:.2f}\n\n"

        interpretation_cn += f"###### ÂΩìÂâçÂ∏ÇÂú∫Ë∂ãÂäøÔºö{trend}\n\n"
        interpretation_cn += f"**ÂΩìÂâç‰ª∑Ê†º**Ôºö{current_price:.2f}\n\n"

        # 2. Ichimoku Cloud Components Explanation
        interpretation_en += "##### üìù Ichimoku Cloud Components Explanation\n"
        interpretation_en += f"""
- **Conversion Line (Tenkan-sen)**: Calculated over **{conversion_line_period} periods**, it represents the average of the highest high and the lowest low over the specified periods. It is a faster-moving average that responds quickly to price changes.
- **Base Line (Kijun-sen)**: Calculated over **{base_line_period} periods**, it serves as an indicator of future price movement. A higher Kijun-sen suggests upward momentum, while a lower Kijun-sen indicates downward momentum.
- **Leading Span B (Senkou Span B)**: Calculated over **{span_b_period} periods**, it forms one boundary of the Ichimoku Cloud. It provides support and resistance levels and helps determine the overall trend.
- **Displacement**: The **{displacement} period(s)** displacement projects the Ichimoku Cloud into the future, creating the Senkou Span A and Senkou Span B lines which form the cloud.
"""

        interpretation_cn += "##### üìù Ichimoku ‰∫ëÁªÑ‰ª∂Ëß£Èáä\n"
        interpretation_cn += f"""
- **ËΩ¨Êç¢Á∫ø (Tenkan-sen)**ÔºöËÆ°ÁÆó{conversion_line_period}‰∏™Âë®ÊúüÁöÑÊúÄÈ´ò‰ª∑ÂíåÊúÄ‰Ωé‰ª∑ÁöÑÂπ≥ÂùáÂÄº„ÄÇÂÆÉÊòØ‰∏Ä‰∏™Âø´ÈÄüÁßªÂä®ÁöÑÂπ≥ÂùáÁ∫øÔºåËÉΩÂ§üËøÖÈÄüÂìçÂ∫î‰ª∑Ê†ºÂèòÂåñ„ÄÇ
- **Âü∫ÂáÜÁ∫ø (Kijun-sen)**ÔºöËÆ°ÁÆó{base_line_period}‰∏™Âë®ÊúüÁöÑÊúÄÈ´ò‰ª∑ÂíåÊúÄ‰Ωé‰ª∑ÁöÑÂπ≥ÂùáÂÄº„ÄÇ‰Ωú‰∏∫Êú™Êù•‰ª∑Ê†ºËµ∞ÂäøÁöÑÊåáÁ§∫Âô®ÔºåÂü∫ÂáÜÁ∫øËæÉÈ´òË°®Êòé‰∏äÂçáÂä®ËÉΩÔºåËæÉ‰ΩéÂàôË°®Êòé‰∏ãÈôçÂä®ËÉΩ„ÄÇ
- **È¢ÜÂÖàË∑®Â∫¶B (Senkou Span B)**ÔºöËÆ°ÁÆó{span_b_period}‰∏™Âë®ÊúüÁöÑÊúÄÈ´ò‰ª∑ÂíåÊúÄ‰Ωé‰ª∑ÁöÑÂπ≥ÂùáÂÄºÔºåÂΩ¢Êàê Ichimoku ‰∫ëÁöÑ‰∏Ä‰∏™ËæπÁïå„ÄÇÂÆÉÊèê‰æõÊîØÊíëÂíåÈòªÂäõ‰ΩçÔºåÂ∏ÆÂä©Á°ÆÂÆöÊï¥‰ΩìË∂ãÂäø„ÄÇ
- **‰ΩçÁßª**ÔºöÂ∞Ü Ichimoku ‰∫ëÂêëÊú™Êù•‰ΩçÁßª{displacement}‰∏™Âë®ÊúüÔºåÂàõÂª∫È¢ÜÂÖàË∑®Â∫¶AÂíåÈ¢ÜÂÖàË∑®Â∫¶BÁ∫øÔºåÂΩ¢Êàê‰∫ëÂ±Ç„ÄÇ
"""

        # 3. Confluence Analysis
        if confluences:
            interpretation_en += "##### üìç Confluence Zones Detected:\n"
            interpretation_cn += "##### üìç Ê£ÄÊµãÂà∞ÁöÑÂÖ±ÊåØÂå∫Ôºö\n"
            for key, indicators in confluences.items():
                if key == 'Bullish Confluence':
                    interpretation_en += (f"- **Bullish Confluence**: EMA{ema_short_window} ({indicators['EMA_Short']:.2f}) is above EMA{ema_long_window} "
                                           f"({indicators['EMA_Long']:.2f}), Ichimoku A ({indicators['Ichimoku_A']:.2f}) is above Ichimoku B "
                                           f"({indicators['Ichimoku_B']:.2f}), and the price is above the cloud. This alignment confirms strong bullish momentum.\n")
                    interpretation_cn += (f"- **ÁúãÊ∂®ÂÖ±ÊåØÂå∫**ÔºöEMA{ema_short_window} ({indicators['EMA_Short']:.2f}) È´ò‰∫é EMA{ema_long_window} "
                                           f"({indicators['EMA_Long']:.2f})ÔºåIchimoku A ({indicators['Ichimoku_A']:.2f}) È´ò‰∫é Ichimoku B "
                                           f"({indicators['Ichimoku_B']:.2f})Ôºå‰∏î‰ª∑Ê†ºÈ´ò‰∫é‰∫ë„ÄÇËøôÁßçÂØπÈΩêÁ°ÆËÆ§‰∫ÜÂº∫Âä≤ÁöÑÁúãÊ∂®Âä®ËÉΩ„ÄÇ\n")
                elif key == 'Bearish Confluence':
                    interpretation_en += (f"- **Bearish Confluence**: EMA{ema_short_window} ({indicators['EMA_Short']:.2f}) is below EMA{ema_long_window} "
                                           f"({indicators['EMA_Long']:.2f}), Ichimoku A ({indicators['Ichimoku_A']:.2f}) is below Ichimoku B "
                                           f"({indicators['Ichimoku_B']:.2f}), and the price is below the cloud. This alignment confirms strong bearish momentum.\n")
                    interpretation_cn += (f"- **ÁúãË∑åÂÖ±ÊåØÂå∫**ÔºöEMA{ema_short_window} ({indicators['EMA_Short']:.2f}) ‰Ωé‰∫é EMA{ema_long_window} "
                                           f"({indicators['EMA_Long']:.2f})ÔºåIchimoku A ({indicators['Ichimoku_A']:.2f}) ‰Ωé‰∫é Ichimoku B "
                                           f"({indicators['Ichimoku_B']:.2f})Ôºå‰∏î‰ª∑Ê†º‰Ωé‰∫é‰∫ë„ÄÇËøôÁßçÂØπÈΩêÁ°ÆËÆ§‰∫ÜÂº∫Âä≤ÁöÑÂçñÂá∫Âä®ËÉΩ„ÄÇ\n")
            interpretation_en += "\n"
            interpretation_cn += "\n"
        else:
            interpretation_en += "##### üìç No Confluence Zones Detected.\n\n"
            interpretation_cn += "##### üìç Êú™Ê£ÄÊµãÂà∞ÂÖ±ÊåØÂå∫„ÄÇ\n\n"

        # 4. Price Position Analysis
        interpretation_en += "##### üîç Price Position Relative to Ichimoku Cloud and EMAs:\n"
        interpretation_cn += "##### üîç ÂΩìÂâç‰ª∑Ê†ºÁõ∏ÂØπ‰∫é Ichimoku ‰∫ëÂíå EMA ÁöÑ‰ΩçÁΩÆÔºö\n"
        if trend == "‰∏äÂçáË∂ãÂäø (Uptrend)":
            interpretation_en += f"- The current price is **above** EMA{ema_short_window} and EMA{ema_long_window}, Ichimoku A is above Ichimoku B, and the price is above the cloud. This indicates a strong **uptrend** with robust buying pressure.\n"
            interpretation_cn += f"- ÂΩìÂâç‰ª∑Ê†º **È´ò‰∫é** EMA{ema_short_window} Âíå EMA{ema_long_window}ÔºåIchimoku A È´ò‰∫é Ichimoku BÔºå‰∏î‰ª∑Ê†ºÈ´ò‰∫é‰∫ë„ÄÇËøôË°®Êòé‰∏Ä‰∏™Âº∫Âä≤ÁöÑ **‰∏äÂçáË∂ãÂäø**ÔºåÂÖ∑ÊúâÂº∫Â§ßÁöÑ‰π∞ÂÖ•ÂéãÂäõ„ÄÇ\n"
        elif trend == "‰∏ãÈôçË∂ãÂäø (Downtrend)":
            interpretation_en += f"- The current price is **below** EMA{ema_short_window} and EMA{ema_long_window}, Ichimoku A is below Ichimoku B, and the price is below the cloud. This indicates a strong **downtrend** with robust selling pressure.\n"
            interpretation_cn += f"- ÂΩìÂâç‰ª∑Ê†º **‰Ωé‰∫é** EMA{ema_short_window} Âíå EMA{ema_long_window}ÔºåIchimoku A ‰Ωé‰∫é Ichimoku BÔºå‰∏î‰ª∑Ê†º‰Ωé‰∫é‰∫ë„ÄÇËøôË°®Êòé‰∏Ä‰∏™Âº∫Âä≤ÁöÑ **‰∏ãÈôçË∂ãÂäø**ÔºåÂÖ∑ÊúâÂº∫Â§ßÁöÑÂçñÂá∫ÂéãÂäõ„ÄÇ\n"
        else:
            interpretation_en += f"- The current price is **within** EMA{ema_short_window} and EMA{ema_long_window}, Ichimoku A and B are interchanging, and the price is within the cloud. This indicates a **consolidating** or **sideways market** with no clear trend.\n"
            interpretation_cn += f"- ÂΩìÂâç‰ª∑Ê†º **‰Ωç‰∫é** EMA{ema_short_window} Âíå EMA{ema_long_window} ‰πãÈó¥ÔºåIchimoku A Âíå B Ê≠£Âú®‰∫§ÊõøÔºå‰∏î‰ª∑Ê†º‰Ωç‰∫é‰∫ëÂÜÖ„ÄÇËøôË°®Êòé‰∏Ä‰∏™ **Êï¥Âêà** Êàñ **Ê®™ÁõòÂ∏ÇÂú∫**ÔºåÊ≤°ÊúâÊòéÊòæÁöÑË∂ãÂäø„ÄÇ\n"
        interpretation_en += "\n"
        interpretation_cn += "\n"

        # 5. Actionable Recommendations
        interpretation_en += "##### üí° Actionable Recommendations:\n"
        interpretation_cn += "##### üí° ÂèØÊìç‰ΩúÁöÑÂª∫ËÆÆÔºö\n"

        # Bullish Confluence
        if 'Bullish Confluence' in confluences:
            interpretation_en += f"- **Buying Opportunity**: When EMA{ema_short_window} is above EMA{ema_long_window}, Ichimoku A is above Ichimoku B, and the price is above the cloud, consider **entering a long position**. This alignment confirms strong bullish momentum.\n"
            interpretation_cn += f"- **‰π∞ÂÖ•Êú∫‰ºö**ÔºöÂΩì EMA{ema_short_window} È´ò‰∫é EMA{ema_long_window}ÔºåIchimoku A È´ò‰∫é Ichimoku BÔºå‰∏î‰ª∑Ê†ºÈ´ò‰∫é‰∫ëÊó∂ÔºåËÄÉËôë **ËøõÂÖ•Â§öÂ§¥‰ªì‰Ωç**„ÄÇËøôÁßçÂØπÈΩêÁ°ÆËÆ§‰∫ÜÂº∫Âä≤ÁöÑÁúãÊ∂®Âä®ËÉΩ„ÄÇ\n"

        # Bearish Confluence
        if 'Bearish Confluence' in confluences:
            interpretation_en += f"- **Selling Opportunity**: When EMA{ema_short_window} is below EMA{ema_long_window}, Ichimoku A is below Ichimoku B, and the price is below the cloud, consider **entering a short position**. This alignment confirms strong bearish momentum.\n"
            interpretation_cn += f"- **ÂçñÂá∫Êú∫‰ºö**ÔºöÂΩì EMA{ema_short_window} ‰Ωé‰∫é EMA{ema_long_window}ÔºåIchimoku A ‰Ωé‰∫é Ichimoku BÔºå‰∏î‰ª∑Ê†º‰Ωé‰∫é‰∫ëÊó∂ÔºåËÄÉËôë **ËøõÂÖ•Á©∫Â§¥‰ªì‰Ωç**„ÄÇËøôÁßçÂØπÈΩêÁ°ÆËÆ§‰∫ÜÂº∫Âä≤ÁöÑÂçñÂá∫Âä®ËÉΩ„ÄÇ\n"

        # Bullish Crossovers
        if bullish_crossovers:
            interpretation_en += "\n- **Bullish Crossover Detected**: EMA{ema_short_window} has crossed above EMA{ema_long_window}, indicating a potential **upward trend**. Consider **entering a long position** when confirmed by bullish candlestick patterns.\n"
            interpretation_cn += "\n- **Ê£ÄÊµãÂà∞ÁúãÊ∂®‰∫§Âèâ**ÔºöEMA{ema_short_window} Â∑≤Áªè‰∏äÁ©ø EMA{ema_long_window}ÔºåË°®ÊòéÂèØËÉΩÂá∫Áé∞ **‰∏äÂçáË∂ãÂäø**„ÄÇÂΩìÈÄöËøáÁúãÊ∂®ÁöÑÁÉõÂè∞ÂΩ¢ÊÄÅÁ°ÆËÆ§Êó∂ÔºåËÄÉËôë **ËøõÂÖ•Â§öÂ§¥‰ªì‰Ωç**„ÄÇ\n"

        # Bearish Crossovers
        if bearish_crossovers:
            interpretation_en += "\n- **Bearish Crossover Detected**: EMA{ema_short_window} has crossed below EMA{ema_long_window}, indicating a potential **downward trend**. Consider **entering a short position** when confirmed by bearish candlestick patterns.\n"
            interpretation_cn += "\n- **Ê£ÄÊµãÂà∞ÂçñÂá∫‰∫§Âèâ**ÔºöEMA{ema_short_window} Â∑≤Áªè‰∏ãÁ©ø EMA{ema_long_window}ÔºåË°®ÊòéÂèØËÉΩÂá∫Áé∞ **‰∏ãÈôçË∂ãÂäø**„ÄÇÂΩìÈÄöËøáÁúãË∑åÁöÑÁÉõÂè∞ÂΩ¢ÊÄÅÁ°ÆËÆ§Êó∂ÔºåËÄÉËôë **ËøõÂÖ•Á©∫Â§¥‰ªì‰Ωç**„ÄÇ\n"

        # Confluence Zones
        if confluences:
            interpretation_en += "\n- **Confluence Zones**: Trades near these areas have a higher probability of success due to the alignment of Ichimoku components with EMAs. Monitor these zones closely for potential trade opportunities.\n"
            interpretation_cn += "\n- **ÂÖ±ÊåØÂå∫**ÔºöÁî±‰∫é Ichimoku ÁªÑ‰ª∂‰∏é EMA ÂØπÈΩêÔºåÊé•ËøëËøô‰∫õÂå∫ÂüüÁöÑ‰∫§ÊòìÊàêÂäüÊ¶ÇÁéáÊõ¥È´ò„ÄÇÂØÜÂàáÂÖ≥Ê≥®Ëøô‰∫õÂå∫Âüü‰ª•ÂØªÊâæÊΩúÂú®ÁöÑ‰∫§ÊòìÊú∫‰ºö„ÄÇ\n"

        # Risk Management
        interpretation_en += "\n##### ‚ö†Ô∏è Risk Management:\n"
        interpretation_cn += "\n##### ‚ö†Ô∏è È£éÈô©ÁÆ°ÁêÜÔºö\n"
        interpretation_en += f"- **Stop-Loss**: Place stop-loss orders just below EMA{ema_short_window} or above EMA{ema_long_window} to manage risk in long and short positions respectively.\n"
        interpretation_cn += f"- **Ê≠¢Êçü**ÔºöÂú®Â§öÂ§¥‰ªì‰Ωç‰∏≠ÔºåÂ∞ÜÊ≠¢ÊçüËÆ¢ÂçïÊîæÁΩÆÂú® EMA{ema_short_window} Êàñ EMA{ema_long_window} ‰∏ãÊñπÔºå‰ª•ÁÆ°ÁêÜÈ£éÈô©ÔºõÂú®Á©∫Â§¥‰ªì‰Ωç‰∏≠ÔºåÂ∞ÜÊ≠¢ÊçüËÆ¢ÂçïÊîæÁΩÆÂú® EMA{ema_long_window} ‰∏äÊñπÔºå‰ª•ÁÆ°ÁêÜÈ£éÈô©„ÄÇ\n"
        interpretation_en += f"- **Take-Profit**: Set target levels based on recent support/resistance levels or use a trailing stop to lock in profits as the trend continues.\n"
        interpretation_cn += f"- **Ê≠¢Áõà**ÔºöÊ†πÊçÆËøëÊúüÁöÑÊîØÊíë/ÈòªÂäõ‰ΩçËÆæÁΩÆÁõÆÊ†áÊ∞¥Âπ≥ÔºåÊàñ‰ΩøÁî®ÁßªÂä®Ê≠¢Áõà‰ª•Âú®Ë∂ãÂäøÊåÅÁª≠Êó∂ÈîÅÂÆöÂà©Ê∂¶„ÄÇ\n"

        # Market Conditions
        interpretation_en += "\n##### üåê Optimal Market Conditions for Applying This Strategy:\n"
        interpretation_cn += "\n##### üåê Â∫îÁî®Ê≠§Á≠ñÁï•ÁöÑÊúÄ‰Ω≥Â∏ÇÂú∫Êù°‰ª∂Ôºö\n"
        interpretation_en += "- **Trending Markets**: Most effective in clear uptrends or downtrends where Ichimoku and EMAs confirm the direction.\n"
        interpretation_cn += "- **Ë∂ãÂäøÂ∏ÇÂú∫**ÔºöÂú® Ichimoku Âíå EMA Á°ÆËÆ§ÊñπÂêëÁöÑÊòéÊòæ‰∏äÂçáÊàñ‰∏ãÈôçË∂ãÂäø‰∏≠ÊúÄ‰∏∫ÊúâÊïà„ÄÇ\n"
        interpretation_en += "- **High Volume**: Ensure significant price movements are supported by high volume to validate Ichimoku signals.\n"
        interpretation_cn += "- **È´òÊàê‰∫§Èáè**ÔºöÁ°Æ‰øùÈáçË¶ÅÁöÑ‰ª∑Ê†ºÊ≥¢Âä®Áî±È´òÊàê‰∫§ÈáèÊîØÊåÅÔºå‰ª•È™åËØÅ Ichimoku ‰ø°Âè∑„ÄÇ\n"
        interpretation_en += "- **Avoid in Sideways/Noisy Markets**: Ichimoku may produce false signals in choppy or non-trending markets.\n"
        interpretation_cn += "- **ÈÅøÂÖçÂú®Ê®™Áõò/ÂòàÊùÇÂ∏ÇÂú∫**ÔºöÂú®Ê≥¢Âä®ÂâßÁÉàÊàñÊó†Ë∂ãÂäøÁöÑÂ∏ÇÂú∫‰∏≠ÔºåIchimoku ÂèØËÉΩ‰∫ßÁîüËôöÂÅá‰ø°Âè∑„ÄÇ\n"

        return interpretation_en, interpretation_cn

    interpret_en, interpret_cn = detailed_interpretation(
        bullish_crossovers, bearish_crossovers, confluences, current_price, trend,
        conversion_line_period, base_line_period, span_b_period, displacement,
        ema_short_window, ema_long_window
    )

    # Display Interpretations
    st.markdown("##### üìÑ ÊåáÊ†áËß£ËØª")

    # Tabs for English and Chinese
    tab1, tab2 = st.tabs(["‰∏≠Êñá", "English"])

    with tab1:
        st.markdown(interpret_cn)

    with tab2:
        st.markdown(interpret_en)

    # Optional: Display Data Table
    with st.expander("üìä Êü•ÁúãÂéüÂßãÊï∞ÊçÆ (View Raw Data)"):
        st.dataframe(df)

        